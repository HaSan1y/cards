(()=>{"use strict";const e=SimpleWebAuthnBrowser;console.log("Script loaded"),document.querySelector("[data-email]");const t=document.querySelector("[data-modal]"),n=document.querySelector("[data-close]");document.addEventListener("DOMContentLoaded",(function(){console.log("DOM fully loaded");const t=document.getElementById("authForm"),n=document.getElementById("formTitle"),a=document.getElementById("formDescription"),i=document.getElementById("emailGroup"),s=document.getElementById("submitButton"),l=document.getElementById("toggleMode"),d=document.getElementById("toggleLabel"),c=document.getElementById("errorMessage"),u=document.getElementById("successMessage");let g=!0;function m(){g?(n.textContent="Login",a.textContent="Welcome back! Please login to your account.",i.style.display="none",s.textContent="Login",s.removeAttribute("data-signup"),s.setAttribute("data-login",""),d.textContent="Need an account?"):(n.textContent="Register",a.textContent="Create a new account to get started.",i.style.display="block",s.textContent="Register",s.removeAttribute("data-login"),s.setAttribute("data-signup",""),d.textContent="Already have an account?"),c.textContent="",u.textContent=""}l.addEventListener("change",(function(){g=!g,m()})),console.log("Form element:",t),console.log("Submit button:",s),s?s.addEventListener("click",(async t=>{t.preventDefault();const n=document.getElementById("username").value.trim(),a=document.getElementById("email").value.trim(),i=document.getElementById("password").value;if(console.log("Form submitted with values:",{username:n,email:a,password:i}),c.textContent="",u.textContent="",n){if(!i||i.length<6)return console.log("Password validation failed"),void(c.textContent="Password is required and must be at least 6 characters long.");if(!g){if(!a)return void(c.textContent="Email is required for registration.");function l(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}if(!l(a))return void(c.textContent="Please enter a valid email address.")}console.log("Validation passed. Proceeding with",g?"Login":"Registration"),s.disabled=!0,s.textContent=g?"Logging in...":"Registering...",s.hasAttribute("data-login")?(console.log("Login attempt"),await async function(){console.log("Login function called"),document.getElementById("errorMessage");const t=document.getElementById("submitButton");try{const n=document.getElementById("username"),a=document.getElementById("password"),i=n.value.trim(),s=a.value;if(console.log("Attempting to log in with username:",i),!i)return void r("Please enter a username");if(!s)return void r("Please enter a password");t&&(t.disabled=!0);const l=await fetch(`${o}init-auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:i,password:s}),credentials:"include"});if(t&&(t.disabled=!1),!l.ok){let e={error:`HTTP error! status: ${l.status}`};try{e=await l.json()}catch(e){}throw new Error(e.error||"Authentication failed")}const d=await l.json();console.log("Options being passed to startAuthentication:",JSON.stringify(d,null,2)),d.allowCredentials&&d.allowCredentials.length>0&&console.log("Credential ID requested:",d.allowCredentials[0].id);const c=await(0,e.startAuthentication)(d);t&&(t.disabled=!0);const u=await fetch(`${o}verify-auth`,{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});t&&(t.disabled=!1);const g=await u.json();if(!u.ok)throw new Error(g.error||"Verification failed");g.verified?r(`Successfully logged in ${i}`):r("Failed to log in")}catch(e){t&&(t.disabled=!1),console.error("Login error:",e),e instanceof DOMException&&"NotAllowedError"===e.name?r("Login cancelled."):e instanceof Error?r(e.message||"An unknown login error occurred."):r("An unexpected error occurred during login.")}}(),window.location.reload()):s.hasAttribute("data-signup")?(console.log("Signup attempt"),await async function(){console.log("Register function called"),document.getElementById("errorMessage");const t=document.getElementById("submitButton");try{const n=document.getElementById("username"),a=document.getElementById("email"),i=document.getElementById("password"),s=n.value.trim(),l=a.value.trim(),d=i.value;if(console.log("Attempting registration for:",s,l),!s)return void r("Please enter a username");if(!l||!/\S+@\S+\.\S+/.test(l))return void r("Please enter a valid email address");if(!d||d.length<6)return void r("Password must be at least 6 characters long");t&&(t.disabled=!0);const c=await fetch(`${o}init-register?email=${encodeURIComponent(l)}`,{credentials:"include"});if(!c.ok){let e={error:`HTTP error! status: ${c.status}`};try{e=await c.json()}catch(e){}throw new Error(e.error||"Registration initialization failed")}const u=await c.json();console.log("Server response:",u);const g=await(0,e.startRegistration)(u);console.log("Registration JSON:",g);const m={...g,username:s,email:l,password:d},f=await fetch(`${o}verify-register`,{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});t&&(t.disabled=!1);const p=await f.json();if(!f.ok)throw new Error(p.error||"Verification failed");p.verified?(r(`Successfully registered ${s}`),n.value="",a.value="",i.value=""):r("Failed to register")}catch(e){t&&(t.disabled=!1),e instanceof DOMException&&"NotAllowedError"===e.name?r("Passkey registration cancelled or not supported."):e instanceof Error?r(e.message||"An unknown registration error occurred."):r("An unexpected error occurred during registration.")}}(),window.location.reload()):(console.log("Button has neither data-login nor data-signup attribute"),m())}else c.textContent="Username is required."})):console.error("Form element not found")})),n.addEventListener("click",(()=>t.close()));const o="https://db-2-cards.vercel.app"===window.location.origin?"https://db-2-cards.vercel.app/api/":"http://localhost:8888"===window.location.origin?"http://localhost:8888/.netlify/functions/N":"https://elegant-bubblegum-a62895.netlify.app"===window.location.origin?"https://elegant-bubblegum-a62895.netlify.app/.netlify/functions/N":"http://localhost:3000/api/";function r(e){t.querySelector("[data-content]").innerText=e,t.showModal()}})();